# 数据流图节点记录绑定功能使用指南

## 功能概述

数据流图节点现在支持绑定到 toolbox 数据文档的具体记录，而不仅仅是文档本身。每个节点可以：
- 绑定多条数据记录
- 添加节点说明
- 添加标签分类
- 所有数据自动保存到数据库

## 核心功能

### 1. 记录绑定
- **多记录支持**: 一个节点可以绑定多条来自不同文档的记录
- **两步选择**: 先选择文档，再选择该文档中的具体记录
- **智能搜索**: 支持在文档列表和记录列表中搜索
- **分页浏览**: 记录列表支持分页，每页显示 20 条

### 2. 节点说明
- **富文本支持**: 支持多行文本说明
- **编辑模式**: 在编辑模式下可以添加/修改说明
- **查看模式**: 非编辑模式下只读显示

### 3. 数据持久化
- **自动保存**: 所有节点数据（包括记录绑定、说明、标签）自动保存
- **MongoDB 存储**: 使用结构化的 dataflow 字段存储
- **加载恢复**: 下次打开项目时自动恢复所有绑定关系

## 使用步骤

### 查看模式（默认）

1. **点击节点**
   - 自动打开节点详情面板（右侧边栏）
   - 显示节点说明、关联记录、标签

2. **查看记录详情**
   - 点击记录卡片上的"查看详情"按钮
   - 在弹窗中查看记录的完整字段信息

3. **关闭面板**
   - 点击面板右上角的 ✕ 按钮
   - 或点击画布空白处

### 编辑模式

1. **进入编辑模式**
   - 点击顶部工具栏的"编辑模式"按钮

2. **添加节点说明**
   - 点击节点打开详情面板
   - 在"节点说明"区域点击"添加说明"或"编辑"
   - 输入说明文本
   - 点击"保存"

3. **绑定数据记录**
   - 在"关联数据记录"区域点击"添加记录"
   - **第一步**: 在文档列表中选择数据文档
     - 可以搜索文档标题或描述
     - 点击文档进入记录选择
   - **第二步**: 选择具体记录
     - 浏览记录列表（显示前 3 个字段）
     - 可以搜索记录内容
     - 勾选需要绑定的记录（支持多选）
     - 使用分页浏览更多记录
   - 点击"确认选择"完成绑定

4. **移除记录绑定**
   - 在记录卡片上点击"移除"按钮
   - 记录立即从节点解绑

5. **添加标签**
   - 在"标签"区域点击"添加标签"
   - 输入标签名称
   - 标签显示为紫色徽章

6. **保存更改**
   - 点击顶部"完成编辑"按钮
   - 所有更改自动保存到数据库

## 数据结构

### 节点数据格式

```typescript
interface DataflowNodeData {
  label: string                    // 节点名称
  subLabel?: string                // 子标签
  iconKey: string                  // 图标
  color: string                    // 颜色
  description?: string             // 节点说明
  linkedRecords?: ToolboxRecordRef[] // 关联的记录列表
  tags?: string[]                  // 标签列表
  status?: 'draft' | 'active' | 'deprecated'
}
```

### 记录引用格式

```typescript
interface ToolboxRecordRef {
  documentId: string              // 所属文档 ID
  documentTitle: string           // 所属文档标题
  recordId: string                // 记录 ID
  recordData: Record<string, any> // 记录数据（用于显示）
  addedAt: Date                   // 添加时间
}
```

## 后端存储

### MongoDB 文档结构

```json
{
  "_id": "...",
  "userId": "...",
  "title": "项目标题",
  "engineType": "dataflow",
  "dataflow": {
    "nodes": [
      {
        "id": "node1",
        "data": {
          "label": "用户输入",
          "description": "处理用户输入的节点",
          "linkedRecords": [
            {
              "documentId": "690d52e56866e27528cf29b2",
              "documentTitle": "定时任务",
              "recordId": "record123",
              "recordData": {
                "定时任务": "数据同步",
                "定时任务名": "sync_data",
                "配置": ["config1", "config2"]
              },
              "addedAt": "2026-01-05T15:30:00Z"
            }
          ],
          "tags": ["重要", "核心流程"]
        }
      }
    ],
    "edges": [...]
  }
}
```

## UI 界面说明

### 节点详情面板

```
┌─────────────────────────────────┐
│ [图标] 节点名称              [×] │
│ 子标签                          │
├─────────────────────────────────┤
│ ▼ 节点说明                      │
│   这是一个处理用户输入的节点... │
│   [编辑]                        │
├─────────────────────────────────┤
│ ▼ 关联数据记录 (2)              │
│   ┌───────────────────────────┐ │
│   │ 来自: 定时任务            │ │
│   │ 定时任务: 数据同步        │ │
│   │ 定时任务名: sync_data     │ │
│   │ [查看详情] [移除]         │ │
│   └───────────────────────────┘ │
│   [+ 添加记录]                  │
├─────────────────────────────────┤
│ ▼ 标签 (2)                      │
│   [重要] [核心流程]             │
│   [+ 添加标签]                  │
└─────────────────────────────────┘
```

### 记录选择器

**文档列表视图:**
```
┌─────────────────────────────────┐
│ 选择数据文档                 [×] │
├─────────────────────────────────┤
│ [搜索框]                        │
├─────────────────────────────────┤
│ 📄 定时任务                  > │
│    10 条记录 | 2026-01-05      │
├─────────────────────────────────┤
│ 📄 用户管理                  > │
│    25 条记录 | 2026-01-04      │
└─────────────────────────────────┘
```

**记录列表视图:**
```
┌─────────────────────────────────┐
│ < 选择记录 - 定时任务        [×] │
├─────────────────────────────────┤
│ [搜索框]                        │
├─────────────────────────────────┤
│ ☑ 定时任务: 数据同步            │
│   定时任务名: sync_data         │
│   配置: ["config1", ...]        │
├─────────────────────────────────┤
│ ☐ 定时任务: 日志清理            │
│   定时任务名: clean_logs        │
│   配置: ["config3", ...]        │
├─────────────────────────────────┤
│ 显示 1-20 条，共 50 条          │
│ [上一页] 1/3 [下一页]           │
├─────────────────────────────────┤
│ 已选择 1 条记录  [取消] [确认]  │
└─────────────────────────────────┘
```

## 技术实现

### 前端组件

1. **RecordSelector.tsx** - 记录选择器
   - 两步选择流程（文档 → 记录）
   - 搜索和分页功能
   - 多选支持

2. **NodeDetailPanel.tsx** - 节点详情面板
   - 显示和编辑节点信息
   - 管理记录绑定
   - 标签管理

3. **RecordViewer.tsx** - 记录查看器
   - 全屏查看记录详情
   - 智能渲染不同字段类型

### 数据流

```
用户操作 → 更新节点数据 → 触发自动保存
    ↓
DataflowEditor → setNodes → 更新 React Flow 状态
    ↓
useEffect 监听 → 序列化为 JSON → setContent
    ↓
EditorPage → 防抖保存 → 更新 IndexedDB
    ↓
用户点击保存 → diagramService.save → 后端 API
    ↓
DiagramService → MongoDB 保存 → 持久化存储
```

## 最佳实践

### 1. 记录选择
- **先规划后绑定**: 明确节点需要哪些数据再进行绑定
- **合理分组**: 使用标签对节点进行分类
- **及时更新**: 当 toolbox 数据更新时，检查绑定是否需要更新

### 2. 说明编写
- **简洁明了**: 说明应该简短但包含关键信息
- **结构化**: 使用换行和缩进提高可读性
- **及时更新**: 节点功能变化时同步更新说明

### 3. 性能优化
- **避免过度绑定**: 每个节点建议绑定 5-10 条记录
- **定期清理**: 删除不再需要的绑定关系
- **合理分页**: 浏览大量记录时使用搜索功能

## 常见问题

### Q: 绑定的记录数据会实时更新吗？
A: 不会。记录数据在绑定时被快照保存。如果 toolbox 中的数据更新了，需要重新绑定。

### Q: 可以绑定来自不同文档的记录吗？
A: 可以。一个节点可以绑定多个文档的多条记录。

### Q: 删除节点会删除关联的 toolbox 数据吗？
A: 不会。删除节点只会删除绑定关系，不影响 toolbox 中的原始数据。

### Q: 如何批量管理多个节点的绑定？
A: 目前需要逐个节点操作。未来可能会添加批量操作功能。

### Q: 数据保存失败怎么办？
A: 数据会先保存到本地 IndexedDB，即使网络断开也不会丢失。恢复网络后点击保存即可同步到服务器。

## 扩展功能建议

### 已实现
- ✅ 记录绑定和查看
- ✅ 节点说明
- ✅ 标签管理
- ✅ 数据持久化

### 计划中
- 🔄 记录数据实时同步
- 🔄 批量绑定操作
- 🔄 绑定关系可视化
- 🔄 记录变更通知
- 🔄 导出绑定关系报告

## 总结

数据流图节点记录绑定功能提供了强大的数据关联能力，让你可以：
- 将抽象的流程图与具体的数据记录关联
- 在一个视图中查看流程和数据
- 快速定位和查看相关数据
- 提高团队协作效率

所有数据自动保存，下次打开项目时完整恢复！
