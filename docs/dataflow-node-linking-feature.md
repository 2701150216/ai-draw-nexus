# 数据流图节点关联功能方案

## 功能概述

为数据流图编辑器添加节点与 toolbox 数据文档的关联功能，支持：
- 节点关联多个数据文档
- 查看关联文档的详细信息和数据记录
- 编辑节点说明和标签
- 美观的交互界面和友好的用户体验

## 核心功能

### 1. 节点数据扩展
- **节点说明** (`description`): 支持多行文本，描述节点的功能和用途
- **关联文档列表** (`linkedDocuments`): 存储关联的 toolbox 文档引用
- **标签** (`tags`): 为节点添加分类标签
- **状态** (`status`): 标记节点状态（草稿/活跃/已废弃）

### 2. 文档选择器 (DocumentSelector)
**功能特性：**
- 从 toolbox 加载所有可用的数据文档
- 支持搜索文档标题和描述
- 多选模式，批量关联文档
- 显示文档基本信息（记录数、更新时间）
- 美观的卡片式列表展示

**交互流程：**
1. 点击"添加文档"按钮打开选择器
2. 搜索或浏览文档列表
3. 勾选需要关联的文档
4. 确认选择，文档添加到节点

### 3. 节点详情面板 (NodeDetailPanel)
**功能特性：**
- 侧边栏展示，不遮挡画布
- 可折叠的分组展示（说明、文档、标签）
- 编辑模式下支持添加/编辑/删除
- 查看模式下只读展示
- 关联文档支持快速查看和跳转

**面板结构：**
```
┌─────────────────────────────┐
│ [节点图标] 节点名称      [×] │
├─────────────────────────────┤
│ ▼ 节点说明                  │
│   [说明文本或编辑框]        │
├─────────────────────────────┤
│ ▼ 关联文档 (2)              │
│   ┌───────────────────────┐ │
│   │ 📄 文档标题           │ │
│   │ 描述...               │ │
│   │ [查看] [打开] [移除]  │ │
│   └───────────────────────┘ │
│   [+ 添加文档]              │
├─────────────────────────────┤
│ ▼ 标签 (3)                  │
│   [标签1] [标签2] [标签3]   │
│   [+ 添加标签]              │
└─────────────────────────────┘
```

### 4. 文档查看器 (DocumentViewer)
**功能特性：**
- 全屏模态窗口展示
- 显示文档元信息（记录数、更新时间、所有者）
- 表格形式展示数据记录
- 支持搜索和分页
- 智能渲染不同字段类型（数组、对象、长文本）

**查看器布局：**
```
┌─────────────────────────────────────┐
│ [图标] 文档标题              [×]    │
│ 文档描述                            │
├─────────────────────────────────────┤
│ 📄 记录数: 150  📅 更新: 2026-01-05 │
│ [搜索框]                            │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 字段1 │ 字段2 │ 字段3 │ 字段4   │ │
│ ├─────────────────────────────────┤ │
│ │ 值1   │ 值2   │ 值3   │ 值4     │ │
│ │ ...   │ ...   │ ...   │ ...     │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ 显示 1-20 条，共 150 条  [<] 1/8 [>]│
└─────────────────────────────────────┘
```

### 5. 节点视觉增强
**关联标识：**
- 有关联文档的节点显示小徽章（数字标识）
- 鼠标悬停显示关联文档数量提示
- 有说明的节点显示信息图标

**交互提示：**
- 点击节点自动打开详情面板
- 编辑模式下高亮可编辑区域
- 平滑的动画过渡效果

## 技术实现

### 数据结构
```typescript
// 节点数据类型
interface DataflowNodeData {
  label: string
  subLabel?: string
  iconKey: string
  color: string
  description?: string              // 节点说明
  linkedDocuments?: ToolboxDocumentRef[]  // 关联文档
  tags?: string[]                   // 标签
  status?: 'draft' | 'active' | 'deprecated'
}

// 文档引用
interface ToolboxDocumentRef {
  id: string
  title: string
  description?: string
  url?: string
  addedAt: Date
}
```

### 服务层
```typescript
// toolboxService.ts
- listDocuments(): 获取文档列表
- getDocument(id): 获取文档详情
- getDocumentRecords(id, params): 获取文档记录
- searchDocuments(query): 搜索文档
```

### 组件层次
```
DataflowEditor
├── CustomNode (增强节点显示)
├── NodeDetailPanel (节点详情面板)
│   ├── DocumentSelector (文档选择器)
│   └── DocumentViewer (文档查看器)
└── PropertyPanel (原有属性面板)
```

## 用户体验优化

### 1. 交互流程优化
- **快速访问**: 点击节点即可查看关联信息
- **批量操作**: 支持一次性关联多个文档
- **智能搜索**: 实时搜索文档，快速定位
- **便捷导航**: 一键跳转到 toolbox 查看完整文档

### 2. 视觉设计
- **渐变背景**: 面板头部使用渐变色增强视觉层次
- **图标系统**: 统一的图标语言提升识别度
- **颜色编码**: 不同状态使用不同颜色标识
- **动画效果**: 平滑的展开/收起动画

### 3. 响应式布局
- 侧边栏固定宽度（384px），不影响画布操作
- 查看器使用模态窗口，最大化显示空间
- 移动端适配（可选）

## 扩展功能建议

### 1. 双向关联
- 在 toolbox 文档中显示被哪些节点引用
- 支持从文档反向导航到数据流图

### 2. 关联分析
- 统计节点关联度（被引用次数）
- 可视化节点间的文档关联关系
- 发现孤立节点（无关联文档）

### 3. 协作功能
- 节点评论系统
- 关联文档的变更通知
- 团队成员的关联推荐

### 4. 智能推荐
- 基于节点名称自动推荐相关文档
- 基于已关联文档推荐相似文档
- 学习用户习惯优化推荐

### 5. 导入导出
- 导出节点关联关系为 JSON
- 批量导入关联配置
- 支持模板保存和复用

### 6. 版本控制
- 记录关联关系的变更历史
- 支持回滚到历史版本
- 对比不同版本的差异

## 配置要求

### 环境变量
```env
VITE_TOOLBOX_API_URL=http://localhost:3000
```

### API 端点
- GET `/api/data-documents` - 获取文档列表
- GET `/api/data-documents/:id` - 获取文档详情
- GET `/api/data-documents/:id/records` - 获取文档记录
- GET `/api/data-documents/search?q=` - 搜索文档

## 使用指南

### 查看模式
1. 点击任意节点打开详情面板
2. 查看节点说明和关联文档
3. 点击"查看"按钮打开文档查看器
4. 点击"打开"跳转到 toolbox 查看完整文档

### 编辑模式
1. 点击顶部"编辑模式"按钮
2. 选择节点，在详情面板中：
   - 点击"添加说明"或"编辑"修改节点说明
   - 点击"添加文档"选择关联文档
   - 点击"添加标签"为节点添加标签
3. 点击"完成编辑"保存更改

## 性能优化

- 文档列表懒加载和虚拟滚动
- 搜索防抖（300ms）
- 记录分页加载（20条/页）
- 组件按需加载（React.lazy）
- 缓存已加载的文档数据

## 测试要点

- [ ] 文档选择器正常加载和搜索
- [ ] 节点详情面板正确显示关联信息
- [ ] 文档查看器正确渲染各种字段类型
- [ ] 编辑模式下可以添加/删除关联
- [ ] 数据正确保存和加载
- [ ] 跨浏览器兼容性
- [ ] 性能测试（大量节点和文档）

## 总结

这套方案提供了完整的节点关联功能，具有：
- ✅ 功能全面：支持查看、编辑、搜索、分页
- ✅ 界面美观：现代化设计，渐变色和动画效果
- ✅ 交互友好：直观的操作流程，快速响应
- ✅ 扩展性强：易于添加新功能和定制
- ✅ 性能优化：懒加载、分页、缓存机制
